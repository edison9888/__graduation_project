<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link href="static/main.css" rel="stylesheet" type="text/css">
        <title>资源编辑器 - 武器</title>
        <link href="static/kendo.common.min.css" rel="stylesheet">
        <link href="static/kendo.metroblack.min.css" rel="stylesheet">
        <style>
        .items-view {
            float: left;
            width: 640px;
            height: 420px;
            margin: 4px;
            padding: 3px;
            -moz-box-shadow: inset 0 0 50px rgba(0,0,0,0.1);
            -webkit-box-shadow: inset 0 0 50px rgba(0,0,0,0.1);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.1);
            border-top: 1px solid rgba(0,0,0,0.1);
            -webkit-border-radius: 8px;
            -moz-border-radius: 8px;
            border-radius: 8px;
        }
        .items-view-viewer {
            width: 480px;
            height: 480px;
            border: 1px solid transparent;
        }
        .items-view-viewer:hover {
            border: 1px solid #00ABA9;
        }
        .items-view-viewer .k-textbox {
            width: 120px;
            border: 0;
        }
        .items-view-viewer .k-textbox:hover {
            color: #00ABA9;
        }
        .items-view-viewer .right {
            text-align: right !important;
        }

        .items-view tr td {
            clear: left;
            padding: 0 3px 0 13px;
            height: 35px;
            line-height: 35px;
        }

        .k-listview {
            border: 0;
            padding: 0;
            min-width: 0;
        }
        .k-listview:after, .product-view dl:after {
            content: ".";
            display: block;
            height: 0;
            clear: both;
            visibility: hidden;
        }
        .edit-buttons {
            text-align: right;
            padding: 5px;
            min-width: 100px;
            border-top: 1px solid rgba(0,0,0,0.1);
            -webkit-border-radius: 8px;
            -moz-border-radius: 8px;
            border-radius: 8px;
        }

        .k-toolbar, #list-view, .k-pager-wrap {
            width: 1024px;
            margin: 0 auto;
            -webkit-border-radius: 11px;
            -moz-border-radius: 11px;
            border-radius: 11px;
        }
        #status-bar {
            width: 100%;
            height: 24px;
            line-height: 24px;
            padding: 0 24px;
            margin: 13px auto;
        }

        span.k-invalid-msg  {
            position: absolute;
            margin-left: 6px;
        }

        .re-description {
            overflow: auto;
            word-break: break-all;
            width: 320px !important;
            height: 100px;
            line-height: 18px;
        }
        </style>

        <script src="static/jquery.min.js"></script>
        <script src="static/kendo.web.min.js"></script>
        <script src="static/REObjectIdEditor.js"></script>
        <script src="static/REDiceEditor.js"></script>
        <script src="static/RECriticalHitRangeEditor.js"></script>
        <script src="static/REApp.js"></script>
        <script src="static/REUtils.js"></script>
        <script src="static/RENavigatorBar.js"></script>
        <script src="static/REWeapon.js"></script>
        <script src="static/REEffect.js"></script>
        <script src="static/REOre.js"></script>
        <script type="text/javascript">
            function RELoadDataCallback(data) {
                if (data) {
                    __targetFileObject = JSON.parse(data);
                } else {
                    __targetFileObject = {
                        name: 'weapon',
                        weapons: []
                    };
                }
                __dataSource = new kendo.data.DataSource({
                    data: __targetFileObject.weapons,
                    batch: true,
                    pageSize: 2,
                    change: function(e) {
                    }
                });
                __dataSource.read();
                $("#pager").kendoPager({
                    dataSource: __dataSource
                });
                __listView.setDataSource(__dataSource);
            }

            function RESaveDataCallback(data) {
                if (data === 'ok') {
                    REStatusBarShow('保存成功');
                } else {
                    REStatusBarShow('保存失败(' + (data ? data : 'unknown error') + ')！');
                }
            }

            function REEditItemById(anId) {
                var editorWindow = $('#kREEditorWindow'),
                    data = __dataSource.get(anId);

                if (editorWindow.length == 0) {
                    editorWindow = $('<div>').appendTo(document.body)
                                    .attr('id', 'kREEditorWindow')
                                    .kendoWindow({
                                        title: '编辑',
                                        modal: true,
                                        width: 660,
                                        height: 480,
                                        resizable: false,
                                        visible: false
                                    })
                    __editorWindow = editorWindow.data('kendoWindow');
                    __editorWindow.setOptions({visible: true});
                }
                if (!data) {
                    data = {
                        id:'W000',
                        name:'',
                        icon:'#',
                        price:1,
                        usage:1,
                        attackType:1,
                        distance:1,
                        range:1,
                        damage:'1d6',
                        damageType:1,
                        criticalHit:{
                            f:'',
                            s:'',
                            b:'',
                            fold:2
                        },
                        dexterity:1,
                        effect:1,
                        ore:1,
                        weight:0,
                        description:''
                    };
                }
                __editorWindow.content(kendo.template($('#edit-item-window-tmpl').html())(data))
                              .center()
                              .open();
                /* init widgets */
                kendo.init('#save-id');
                kendo.init('#save-damage');
                kendo.init('#save-critical-hit-range');
                $('#save-usage').kendoDropDownList({
                    dataTextField: "name",
                    dataValueField: "value",
                    dataSource: REWeaponUsages
                });
                $('#save-attack-type').kendoDropDownList({
                    dataTextField: "name",
                    dataValueField: "value",
                    dataSource: REWeaponAttackTypes
                });
                $('#save-damage-type').kendoDropDownList({
                    dataTextField: "name",
                    dataValueField: "value",
                    dataSource: REWeaponDamageTypes
                });
                $('#save-ore').kendoDropDownList({
                    dataTextField: "name",
                    dataValueField: "value",
                    dataSource: REOres
                });
                $('#save-effect').kendoDropDownList({
                    dataTextField: "name",
                    dataValueField: "value",
                    dataSource: REEffects
                });
                $('#save-price').kendoNumericTextBox({
                    min: 0,
                    max: 1000,
                    step: 1,
                    format: '# 马克'
                });
                $('.re-numeric').kendoNumericTextBox({
                    min: 0,
                    max: 10,
                    step: 1,
                    format: '#'
                });
                $('.re-critical-hit-fold').kendoDropDownList({
                    dataTextField: 'text',
                    dataValueField: 'value',
                    dataSource: __criticalHitFoldDataSource
                });
                $('.re-dexterity').kendoNumericTextBox({
                    min: -10,
                    max: 10,
                    step: 1,
                    format: '#'
                });
                $('#save-weight').kendoNumericTextBox({
                    min: 0,
                    max: 100,
                    step: 1,
                    format: "# 磅"
                });
            }

            function REDeleteItemById(anId) {
                var data = __dataSource.get(anId);
                __dataSource.remove(data);
            }

            function RESaveItemById(anId) {
                var data = __dataSource.get(anId),
                    idValue = $('#save-id').data('kendoObjectIdEditor').getData(),
                    nameValue = $('#save-name').val(),
                    iconValue = $('#save-icon').attr('src'),
                    priceValue = $('#save-price').val(),
                    usageValue = $('#save-usage').val(),
                    attackTypeValue = $('#save-attack-type').val(),
                    distanceValue = $('#save-distance').val(),
                    rangeValue = $('#save-range').val(),
                    damageValue = $('#save-damage').data('kendoDiceEditor').getData(),
                    damageTypeValue = $('#save-damage-type').val(),
                    criticalHitData = $('#save-critical-hit-range').data('kendoCriticalHitRangeEditor').getData(),
                    criticalHitValue = criticalHitData ? criticalHitData.split('/') : null,
                    criticalHitFoldValue = $('#save-critical-hit-fold').val(),
                    dexterityValue = $('#save-dexterity').val(),
                    effectValue = $('#save-effect').val(),
                    oreValue = $('#save-ore').val(),
                    weightValue = $('#save-weight').val(),
                    descriptionValue = $('#save-description').val(),
                    needInsert = false;

                if (!idValue || !nameValue) {
                    alert('ID和名字不能为空！');
                    return;
                }

                if (!priceValue) {
                    alert('价格不能为空！');
                    return;
                }
                if (!distanceValue) {
                    alert('攻击距离不能为空！');
                    return;
                }
                if (!rangeValue) {
                    alert('攻击范围不能为空！');
                    return;
                }
                if (!criticalHitValue) {
                    alert('重击范围不能为空！');
                    return;
                }
                if (!criticalHitFoldValue) {
                    alert('重击不能为空！');
                    return;
                }
                if (!dexterityValue) {
                    alert('敏捷不能为空！');
                    return;
                }
                if (!weightValue) {
                    alert('重量不能为空！');
                    return;
                }
                if (!data) {
                    data = {};
                    data.criticalHit = {};
                    needInsert = true;
                }
                data.id = idValue;
                data.name = nameValue;
                data.icon = iconValue;
                data.price = priceValue;
                data.usage = usageValue;
                data.attackType = attackTypeValue;
                data.distance = distanceValue;
                data.range = rangeValue;
                data.damage = damageValue;
                data.damageType = damageTypeValue;
                data.criticalHit.f = criticalHitValue[0];
                data.criticalHit.s = criticalHitValue[1];
                data.criticalHit.b = criticalHitValue[2];
                data.criticalHit.fold = criticalHitFoldValue;
                data.dexterity = dexterityValue;
                data.effect = effectValue;
                data.ore = oreValue;
                data.weight = weightValue;
                data.description = descriptionValue;
                if (needInsert) {
                    __dataSource.add(data);
                }
                __listView.refresh();
                __editorWindow.close();
            }

            function RESaveItems() {
                var dataPath = REResourceGetMCResourcesPath('weapons.json');

                __targetFileObject.weapons = __dataSource.data().toJSON();
                $.post('/services/writeFile', {
                    path: dataPath,
                    data: JSON.stringify(__targetFileObject)
                }, RESaveDataCallback);
            }

            function RECancel() {
                __editorWindow.close();
            }
            
            function REShowEditButtons(id) {
                $('#' + id).show();
            }

            function REHideEditButtons(id) {
                $('#' + id).hide();
            }

            function REStatusBarShow(data) {
                $('#status-bar').html(data);
            }

            $(document).ready(function () {
                 __listView = $("#list-view").kendoListView({
                                    dataSource: __dataSource,
                                    template: kendo.template($("#item-tmpl").html())
                                }).data("kendoListView");

                $(".k-save-button").click(function(e) {
                    RESaveItems();
                });

                $(".k-add-button").click(function(e) {
                    REEditItemById(null);
                });

                REAppInit();

                var dataPath = REResourceGetMCResourcesPath('weapons.json');
                $.post('/services/requestFile', {
                    path: dataPath
                }, RELoadDataCallback);
            });

            var __targetFileObject,
                __dataSource,
                __listView,
                __editorWindow,
                __criticalHitFoldDataSource = [
                { text: 'x 2', value: 2 },
                { text: 'x 3', value: 3 },
                { text: 'x 4', value: 4 },
                { text: 'x 5', value: 5 }
            ];
        </script>
        </head>
        <body class="k-content">
            <div id="navigator-bar" style="height: 48px;"></div>         
            <div class="k-block">
                <div class="k-toolbar k-grid-toolbar">
                    <a class="k-button k-button-icontext k-save-button" href="#">
                        <span class="k-icon k-i-pencil"></span>保存
                    </a>
                    <a class="k-button k-button-icontext k-add-button" href="#">
                        <span class="k-icon k-add"></span>添加
                    </a>
                </div>
                <div id="list-view"></div>
                <div id="pager" class="k-pager-wrap"></div>
                <div id="status-bar" class="k-button k-state-disabled unselectable" style="text-align: left"></div>
            </div>
            <script type="text/x-kendo-tmpl" id="item-tmpl">
                <div class="items-view items-view-viewer" onmouseover="REShowEditButtons('edit-buttons-${id}')" onmouseout="REHideEditButtons('edit-buttons-${id}')">
                    <table>
                        <tr>
                            <td class="right">图标</td>
                            <td>
                            <img src="${icon}" alt="" width="32" height="32" />
                            </td>
                            <td class="right">伤害值</td>
                            <td>
                                <span class="k-textbox">${damage}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">ID</td>
                            <td>
                                <span class="k-textbox">${id}</span>
                            </td>
                            <td class="right">伤害类型</td>
                            <td>
                                <span class="k-textbox">${REWeaponDamageTypeGetName(parseInt(damageType))}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">名字</td>
                            <td>
                                <span class="k-textbox">${name}</span>
                            </td>
                            <td class="right">重击范围</td>
                            <td>
                                <span class="k-textbox">${criticalHit.f} / ${criticalHit.s} / ${criticalHit.b}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">价格</td>
                            <td>
                                <span class="k-textbox">${price} 马克</span>
                            </td>
                            <td class="right">重击</td>
                            <td>
                                <span class="k-textbox">x ${criticalHit.fold}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">使用方法</td>
                            <td>
                                <span class="k-textbox">${REWeaponUsageGetName(parseInt(usage))}</span>
                            </td>
                            <td class="right">敏捷调整值</td>
                            <td>
                                <span class="k-textbox">${dexterity >= 0 ? '+' + dexterity : dexterity}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">攻击类型</td>
                            <td>
                                <span class="k-textbox">${REWeaponAttackTypeGetName(parseInt(attackType))}</span>
                            </td>
                            <td class="right">附带效果</td>
                            <td>
                                <span class="k-textbox">${REEffectGetName (parseInt(effect))}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">攻击距离</td>
                            <td>
                                <span class="k-textbox">${distance}</span>
                            </td>
                            <td class="right">矿石</td>
                            <td>
                                <span class="k-textbox">${REOreGetName(parseInt(ore))}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">攻击范围</td>
                            <td>
                                <span class="k-textbox">${range}</span>
                            </td>
                            <td class="right">重量</td>
                            <td>
                                <span class="k-textbox">${weight} 磅</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">描述</td>
                            <td colspan="3">
                                <span class="k-textbox re-description">${description}</span>
                            </td>
                        </tr>
                    </table>
                    <div id="edit-buttons-${id}" class="edit-buttons" style="display: none;">
                        <a class="k-button k-button-icontext" href="javascript: REEditItemById('${id}');">
                             <span class="k-icon k-edit"></span>编辑
                         </a>
                         <a class="k-button k-button-icontext" href="javascript: REDeleteItemById('${id}')">
                             <span class="k-icon k-delete"></span>删除
                         </a>
                    </div>
                </div>
            </script>
            <script type="text/x-kendo-tmpl" id="edit-item-window-tmpl">
                <div class="items-view">
                    <table>
                        <tr>
                            <td class="right">图标</td>
                            <td>
                                <img id="save-icon" src="${icon}" alt="" width="32" height="32" />
                            </td>
                            <td class="right">伤害值</td>
                            <td>
                                <div id="save-damage" data-role="diceeditor" init-data="${damage}"></div>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">ID</td>
                            <td>
                                <div id="save-id" data-role="objectideditor" init-data="${id}"></div>
                            </td>
                            <td class="right">伤害类型</td>
                            <td>
                                <input id="save-damage-type" value="${damageType}" />
                            </td>
                        </tr>
                        <tr>
                            <td class="right">名字</td>
                            <td>
                                <input id="save-name" value="${name}" class="k-textbox">
                            </td>
                            <td class="right">重击范围</td>
                            <td>
                                <div id="save-critical-hit-range" data-role="criticalhitrangeeditor" init-data="${criticalHit.f} / ${criticalHit.s} / ${criticalHit.b}"></div>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">价格</td>
                            <td>
                                <input id="save-price" value="${price}">
                            </td>
                            <td class="right">重击</td>
                            <td>
                                <input id="save-critical-hit-fold" value="${criticalHit.fold}" class="re-critical-hit-fold">
                            </td>
                        </tr>
                        <tr>
                            <td class="right">使用方法</td>
                            <td>
                                <input id="save-usage" value="${usage}" />
                            </td>
                            <td class="right">敏捷调整值</td>
                            <td>
                                <input id="save-dexterity" value="${dexterity}" class="re-dexterity">
                            </td>
                        </tr>
                        <tr>
                            <td class="right">攻击类型</td>
                            <td>
                                <input id="save-attack-type" value="${attackType}" />
                            </td>
                            <td class="right">附带效果</td>
                            <td>
                                <input id="save-effect" value="${effect}" />
                            </td>
                        </tr>
                        <tr>
                            <td class="right">攻击距离</td>
                            <td>
                                <input id="save-distance" value="${distance}" class="re-numeric">
                            </td>
                            <td class="right">矿石</td>
                            <td>
                                <input id="save-ore" value="${ore}" />
                            </td>
                        </tr>
                        <tr>
                            <td class="right">攻击范围</td>
                            <td>
                                <input id="save-range" value="${range}" class="re-numeric">
                            </td>
                            <td class="right">重量</td>
                            <td>
                                <input id="save-weight" value="${weight}" class="re-weight">
                            </td>
                        </tr>
                        <tr>
                            <td class="right">描述</td>
                            <td colspan="3">
                                <textarea id="save-description" rows="4" cols="30" style="width: 100%; height: 100px" class="k-textbox">${description}</textarea>
                            </td>
                        </tr>
                    </table>
                    <div class="edit-buttons">
                        <a class="k-button k-button-icontext" href="javascript: RESaveItemById('${id}');">
                             <span class="k-icon k-edit"></span>储存
                         </a>
                         <a class="k-button k-button-icontext" href="javascript: RECancel();">
                             <span class="k-icon k-delete"></span>取消
                         </a>
                    </div>
                </div>
            </script>
        </body>
</html>
