<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link href="static/main.css" rel="stylesheet" type="text/css">
        <title>资源编辑器 - 矿石</title>
        <link href="static/kendo.common.min.css" rel="stylesheet">
        <link href="static/kendo.metroblack.min.css" rel="stylesheet">
        <style>
        .items-view {
            float: left;
            width: 640px;
            height: 360px;
            margin: 4px;
            padding: 3px;
            -moz-box-shadow: inset 0 0 50px rgba(0,0,0,0.1);
            -webkit-box-shadow: inset 0 0 50px rgba(0,0,0,0.1);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.1);
            border-top: 1px solid rgba(0,0,0,0.1);
            -webkit-border-radius: 8px;
            -moz-border-radius: 8px;
            border-radius: 8px;
        }
        .items-view-viewer {
            width: 480px;
            height: 410px;
            border: 1px solid transparent;
        }
        .items-view-viewer:hover {
            border: 1px solid #00ABA9;
        }
        .items-view-viewer .k-textbox {
            width: 120px;
            border: 0;
        }
        .items-view-viewer .k-textbox:hover {
            color: #00ABA9;
        }
        .items-view-viewer .right {
            text-align: right !important;
        }

        .items-view tr td {
            clear: left;
            padding: 0 3px 0 13px;
            height: 35px;
            line-height: 35px;
        }
        .items-view td[colspan="4"] {
            text-align: center;
        }

        .k-listview {
            border: 0;
            padding: 0;
            min-width: 0;
        }
        .k-listview:after, .product-view dl:after {
            content: ".";
            display: block;
            height: 0;
            clear: both;
            visibility: hidden;
        }
        .edit-buttons {
            text-align: right;
            padding: 5px;
            min-width: 100px;
            border-top: 1px solid rgba(0,0,0,0.1);
            -webkit-border-radius: 8px;
            -moz-border-radius: 8px;
            border-radius: 8px;
        }

        .k-toolbar, #list-view, .k-pager-wrap {
            width: 1024px;
            margin: 0 auto;
            -webkit-border-radius: 11px;
            -moz-border-radius: 11px;
            border-radius: 11px;
        }
        #status-bar {
            width: 100%;
            height: 24px;
            line-height: 24px;
            padding: 0 24px;
            margin: 13px auto;
        }

        span.k-invalid-msg  {
            position: absolute;
            margin: 6px;
        }

        .re-description {
            overflow: auto;
            word-break: break-all;
            width: 320px !important;
            height: 100px;
            line-height: 18px;
        }
        </style>

        <script src="static/jquery.min.js"></script>
        <script src="static/kendo.web.min.js"></script>
        <script src="static/REObjectIdEditor.js"></script>
        <script src="static/REDiceEditor.js"></script>
        <script src="static/RECriticalHitRangeEditor.js"></script>
        <script src="static/REApp.js"></script>
        <script src="static/REUtils.js"></script>
        <script src="static/RENavigatorBar.js"></script>
        <script src="static/REWeapon.js"></script>
        <script src="static/REEffect.js"></script>
        <script src="static/REOre.js"></script>
        <script type="text/javascript">
            function RELoadDataCallback(data) {
                if (data) {
                    __targetFileObject = JSON.parse(data);
                } else {
                    __targetFileObject = {
                        name: 'ore',
                        ores: []
                    };
                }
                __dataSource = new kendo.data.DataSource({
                    data: __targetFileObject.ores,
                    batch: true,
                    pageSize: 2,
                    change: function(e) {
                    }
                });
                __dataSource.read();
                $("#pager").kendoPager({
                    dataSource: __dataSource
                });
                __listView.setDataSource(__dataSource);
            }

            function RESaveDataCallback(data) {
                if (data === 'ok') {
                    REStatusBarShow('保存成功');
                } else {
                    REStatusBarShow('保存失败(' + (data ? data : 'unknown error') + ')！');
                }
            }

            function REEditItemById(anId) {
                var editorWindow = $('#kREEditorWindow'),
                    data = __dataSource.get(anId);

                if (editorWindow.length == 0) {
                    editorWindow = $('<div>').appendTo(document.body)
                                    .attr('id', 'kREEditorWindow')
                                    .kendoWindow({
                                        title: '编辑',
                                        modal: true,
                                        width: 660,
                                        height: 420,
                                        resizable: false,
                                        visible: false
                                    })
                    __editorWindow = editorWindow.data('kendoWindow');
                    __editorWindow.setOptions({visible: true});
                }
                if (!data) {
                    data = {
                        id:'O000',
                        name:'',
                        icon:'#',
                        damage:0,
                        criticalHit:0,
                        weightWeapon:0,
                        weightArmor:0,
                        dexterityWeapon:0,
                        dexterityArmor:0,
                        armorCheckPenalty:0,
                        description:''
                    };
                }
                __editorWindow.content(kendo.template($('#edit-item-window-tmpl').html())(data))
                              .center()
                              .open();
                /* init widgets */
                kendo.init('#save-id');
                kendo.init('#save-damage');
                $('#save-damage').kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    dataSource: __damage_weightDataSource
                });
                $('#save-critical-hit').kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    dataSource: __criticalHitDataSource
                });
                $('#save-weight-weapon').kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    dataSource: __damage_weightDataSource
                });
                $('#save-weight-armor').kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    dataSource: __damage_weightDataSource
                });
                $('#save-dexterity-weapon').kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    dataSource: __dexterityDataSource
                });
                $('#save-dexterity-armor').kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    dataSource: __dexterityDataSource
                });
                $('#save-armor-check-penalty').kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    dataSource: __armorCheckPenaltyDataSource
                });
            }

            function REDeleteItemById(anId) {
                var data = __dataSource.get(anId);
                __dataSource.remove(data);
            }

            function RESaveItemById(anId) {
                var data = __dataSource.get(anId),
                    idValue = $('#save-id').data('kendoObjectIdEditor').getData(),
                    nameValue = $('#save-name').val(),
                    iconValue = $('#save-icon').attr('src'),
                    damageValue = $('#save-damage').val(),
                    criticalHitValue = $('#save-critical-hit').val(),
                    weightWeaponValue = $('#save-weight-weapon').val(),
                    weightArmorValue = $('#save-weight-armor').val(),
                    dexterityWeaponValue = $('#save-dexterity-weapon').val(),
                    dexterityArmorValue = $('#save-dexterity-armor').val(),
                    armorCheckPenaltyValue = $('#save-armor-check-penalty').val(),
                    descriptionValue = $('#save-description').val(),
                    needInsert = false;

                if (!idValue || !nameValue) {
                    alert('ID和名字不能为空！');
                    return;
                }

                if (!data) {
                    data = {};
                    needInsert = true;
                }
                data.id = idValue;
                data.name = nameValue;
                data.icon = iconValue;
                data.damage = damageValue;
                data.criticalHit = criticalHitValue;
                data.weightWeapon = weightWeaponValue;
                data.weightArmor = weightArmorValue;
                data.dexterityWeapon = dexterityWeaponValue;
                data.dexterityArmor = dexterityArmorValue;
                data.armorCheckPenalty = armorCheckPenaltyValue;
                data.description = descriptionValue;
                if (needInsert) {
                    __dataSource.add(data);
                }
                __listView.refresh();
                __editorWindow.close();
            }

            function RESaveItems() {
                var dataPath = REResourceGetMCResourcesPath('ores.json');

                __targetFileObject.weapons = __dataSource.data().toJSON();
                $.post('/services/writeFile', {
                    path: dataPath,
                    data: JSON.stringify(__targetFileObject)
                }, RESaveDataCallback);
            }

            function RECancel() {
                __editorWindow.close();
            }
            
            function REShowEditButtons(id) {
                $('#' + id).show();
            }

            function REHideEditButtons(id) {
                $('#' + id).hide();
            }

            function REStatusBarShow(data) {
                $('#status-bar').html(data);
            }

            $(document).ready(function () {
                 __listView = $("#list-view").kendoListView({
                                    dataSource: __dataSource,
                                    template: kendo.template($("#item-tmpl").html())
                                }).data("kendoListView");

                $(".k-save-button").click(function(e) {
                    RESaveItems();
                });

                $(".k-add-button").click(function(e) {
                    REEditItemById(null);
                });

                REAppInit();

                var dataPath = REResourceGetMCResourcesPath('ores.json');
                $.post('/services/requestFile', {
                    path: dataPath
                }, RELoadDataCallback);
            });

            var __targetFileObject,
                __dataSource,
                __listView,
                __editorWindow,
                __damage_weightDataSource = [
                    { text: '+0', value: 0 },
                    { text: '+1', value: 1 },
                    { text: '+2', value: 2 },
                    { text: '+3', value: 3 },
                    { text: '+4', value: 4 },
                    { text: '+5', value: 5 }
                ],
                __criticalHitDataSource = [
                    { text: '+0', value: 0 },
                    { text: '+0.5', value: 0.5 },
                    { text: '+1', value: 1 },
                    { text: '+1.5', value: 1.5 },
                    { text: '+2', value: 2 },
                ],
                __dexterityDataSource = [
                    { text: '-5', value: -5 },
                    { text: '-4', value: -4 },
                    { text: '-3', value: -3 },
                    { text: '-2', value: -2 },
                    { text: '-1', value: -1 },
                    { text: '+0', value: 0 },
                    { text: '+1', value: 1 },
                    { text: '+2', value: 2 },
                    { text: '+3', value: 3 },
                    { text: '+4', value: 4 },
                    { text: '+5', value: 5 }
                ],
                __armorCheckPenaltyDataSource = [
                    { text: '-5', value: -5 },
                    { text: '-4', value: -4 },
                    { text: '-3', value: -3 },
                    { text: '-2', value: -2 },
                    { text: '-1', value: -1 },
                    { text: '+0', value: 0 }
                ];
        </script>
        </head>
        <body class="k-content">
            <div id="navigator-bar" style="height: 48px;"></div>         
            <div class="k-block">
                <div class="k-toolbar k-grid-toolbar">
                    <a class="k-button k-button-icontext k-save-button" href="#">
                        <span class="k-icon k-i-pencil"></span>保存
                    </a>
                    <a class="k-button k-button-icontext k-add-button" href="#">
                        <span class="k-icon k-add"></span>添加
                    </a>
                </div>
                <div id="list-view"></div>
                <div id="pager" class="k-pager-wrap"></div>
                <div id="status-bar" class="k-button k-state-disabled unselectable" style="text-align: left"></div>
            </div>
            <script type="text/x-kendo-tmpl" id="item-tmpl">
                <div class="items-view items-view-viewer" onmouseover="REShowEditButtons('edit-buttons-${id}')" onmouseout="REHideEditButtons('edit-buttons-${id}')">
                    <table>
                        <tr>
                            <td class="right">图标</td>
                            <td>
                            <img src="${icon}" alt="" width="32" height="32" />
                            </td>
                            <td class="right">伤害调整值</td>
                            <td>
                                <span class="k-textbox">+${damage}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">ID</td>
                            <td>
                                <span class="k-textbox">${id}</span>
                            </td>
                            <td class="right">重击调整值</td>
                            <td>
                                <span class="k-textbox">+${criticalHit}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">名字</td>
                            <td>
                                <span class="k-textbox">${name}</span>
                            </td>
                            <td class="right">防具检定调整</td>
                            <td>
                                <span class="k-textbox">${armorCheckPenalty >= 0 ? '+' + armorCheckPenalty : armorCheckPenalty}</span>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                <span>重量调整值(磅)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">武器</td>
                            <td>
                                <span class="k-textbox">+${weightWeapon}</span>
                            </td>
                            <td class="right">防具</td>
                            <td>
                                <span class="k-textbox">+${weightArmor}</span>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                <span>敏捷调整值</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">武器</td>
                            <td>
                                <span class="k-textbox">${dexterityWeapon >= 0 ? '+' + dexterityWeapon : dexterityWeapon}</span>
                            </td>
                            <td class="right">防具</td>
                            <td>
                                <span class="k-textbox">${dexterityArmor >= 0 ? '+' + dexterityArmor : dexterityArmor}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">描述</td>
                            <td colspan="3">
                                <span class="k-textbox re-description">${description}</span>
                            </td>
                        </tr>
                    </table>
                    <div id="edit-buttons-${id}" class="edit-buttons" style="display: none;">
                        <a class="k-button k-button-icontext" href="javascript: REEditItemById('${id}');">
                             <span class="k-icon k-edit"></span>编辑
                         </a>
                         <a class="k-button k-button-icontext" href="javascript: REDeleteItemById('${id}')">
                             <span class="k-icon k-delete"></span>删除
                         </a>
                    </div>
                </div>
            </script>
            <script type="text/x-kendo-tmpl" id="edit-item-window-tmpl">
                <div class="items-view">
                    <table>
                        <tr>
                            <td class="right">图标</td>
                            <td>
                                <img id="save-icon" src="${icon}" alt="" width="32" height="32" />
                            </td>
                            <td class="right">伤害调整值</td>
                            <td>
                                <input id="save-damage" value="${damage}">
                            </td>
                        </tr>
                        <tr>
                            <td class="right">ID</td>
                            <td>
                                <div id="save-id" data-role="objectideditor" init-data="${id}"></div>
                            </td>
                            <td class="right">重击调整值</td>
                            <td>
                                <input id="save-critical-hit" value="${name}">
                            </td>
                        </tr>
                        <tr>
                            <td class="right">名字</td>
                            <td>
                                <input id="save-name" value="${name}" class="k-textbox">
                            </td>
                            <td class="right">防具检定调整</td>
                            <td>
                                <input id="save-armor-check-penalty" value="${armorCheckPenalty}">
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4" class="segment-view-top-right">
                                <span>重量调整值(磅)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">武器</td>
                            <td>
                                <input id="save-weight-weapon" value="${weightWeapon}">
                            </td>
                            <td class="right">防具</td>
                            <td>
                                <input id="save-weight-armor" value="${weightArmor}">
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4" class="segment-view-top-right">
                                <span>敏捷调整值</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="right">武器</td>
                            <td class="segment-view">
                                <input id="save-dexterity-weapon" value="${dexterityWeapon}">
                            </td>
                            <td class="right">防具</td>
                            <td>
                                <input id="save-dexterity-armor" value="${dexterityArmor}">
                            </td>
                        </tr>
                        <tr>
                            <td class="right">描述</td>
                            <td colspan="3">
                                <textarea id="save-description" rows="4" cols="30" style="width: 100%; height: 100px" class="k-textbox">${description}</textarea>
                            </td>
                        </tr>
                    </table>
                    <div class="edit-buttons">
                        <a class="k-button k-button-icontext" href="javascript: RESaveItemById('${id}');">
                             <span class="k-icon k-edit"></span>储存
                         </a>
                         <a class="k-button k-button-icontext" href="javascript: RECancel();">
                             <span class="k-icon k-delete"></span>取消
                         </a>
                    </div>
                </div>
            </script>
        </body>
</html>
