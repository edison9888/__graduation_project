#! /usr/bin/env node

var http = require('http');
var fs = require('fs');
var url = require('url');
var qs = require('querystring');

var __fakePath = 'fakepath'
var __resourcePath = '../Resources/iphone';

String.prototype.startswith = function (s) {
    return s.length > 0 && this.indexOf(s) === 0;
}

String.prototype.endswith = function (s) { 
    var i = this.lastIndexOf(s);

    if (i === -1) {
        return false;
    }

    return this.length - i === s.length; 
}

String.prototype.stringByDeletingPathExtension = function () {
    var i = this.lastIndexOf('.');

    return this.substring(0, i);
}

function fakepathToRealPath(aFakePath) {
    return aFakePath.replace(__fakePath + '/', __resourcePath + '/')
}

var REService = {
    name: undefined,
    handler: function () {},
    argv: [],
    json: false,
    failedText: '',

    extend: function (options) {
        return {
            name: options.name,
            handler: typeof options.handler === 'function' ? options.handler : this.handler,
            argv: Array.isArray(options.argv) ? options.argv : this.argv,
            json: options.isJSON === true ? true : false,
            failedText: typeof options.failedText === 'string' ? options.failedText : this.failedText
        }
    }
}

var services = {
    _services: {},
    _prefix: '/services/',
    init: function (callback, data) {
        callback(data);
    },
    install: function (aService) {
        this._services[aService.name] = aService;
        console.log(aService)
    },
    uninstall: function (aService) {
        if (typeof aService === 'string') {
            delete this._services[aService];
        } else {
            delete this._services[aService.name];
        }
    },
    dispatch: function (aServiceName, aRequest, aResponse) {
        var body = '',
            service = this._services[aServiceName],
            postData,
            argumentName,
            arguments,
            result;

        if (! service) { /* 木有此服务 */
            return;
        }

        aRequest.on('data', function (data) {
            body += data;
        });
        aRequest.on('end', function () {
            postData = qs.parse(body);
            arguments = {};
            for (var i = 0; i < service.argv.length; ++i) {
                argumentName = service.argv[i];
                if (! postData[argumentName]) { /* 参数不够 */
                    return;
                }
                arguments[argumentName] = postData[argumentName];
            }
            result = service.handler(arguments);
            if (result !== false || result != null) { /* 成功执行服务 */
                console.log(service.json)
                aResponse.end(service.json ? JSON.stringify(result) : result);
            } else {
                aResponse.end(service.failedText);
            }
        });
    }
}

services.init(function () {
    /* requestFile */
    services.install(REService.extend({
        name: 'requestFile',
        handler: function (arguments) {
            var path = fakepathToRealPath(arguments.path);

            if (fs.existsSync(path)) {
                return fs.readFileSync(path);
            } else {
                return false;
            }
        },
        argv: ['path'],
        json: false,
        failedText: ''
    }));

    /* writeFile */
    services.install(REService.extend({
        name: 'writeFile',
        handler: function (arguments) {
            var path = fakepathToRealPath(arguments.path);
            
            fs.writeFileSync(path, arguments.data);
            return 'ok';
        },
        argv: ['path', 'data'],
        json: false,
        failedText: '参数错误(path: ${path}, data: ${data})！'
    }));

    /* deleteFile */
    services.install(REService.extend({
        name: 'deleteFile',
        handler: function (arguments) {
            var path = fakepathToRealPath(arguments.path);

            if (fs.existsSync(path)) {
                fs.unlinkSync(path);
                return 'done';
            } else {
                return false;
            }
        },
        argv: ['path'],
        json: false,
        failedText: 'failed'
    }));

    /* listDirectory */
    services.install(REService.extend({
        name: 'listDirectory',
        handler: function (arguments) {
            var path = fakepathToRealPath(arguments.path);
            
            if (fs.existsSync(path)) {
                return fs.readdirSync(path);
            } else {
                return null;
            }
        },
        argv: ['path'],
        json: true,
        failedText: '[]'
    }));

    /* 安装特殊服务 */
    /* 搜索返回符合格式的精灵表 */
    /* writeFile */
    services.install(REService.extend({
        name: 'spriteSheet',
        handler: function (arguments) {
            var files = fs.readdirSync(__resourcePath),
                plists = [],
                spriteSheet = [];

            /* 以plist文件为参考 */
            for (var i = 0; i < files.length; ++i) {
                if (files[i].endswith('.plist')) {
                    plists.push(files[i].stringByDeletingPathExtension());
                }
            }

            for (var i = 0; i < plists.length; ++i) {
                for (var j = 0; j < files.length; ++j) {
                    if (files[j].startswith(plists[i])
                        && !files[j].endswith('.plist')) {
                        spriteSheet.push(plists[i]);
                    }
                }
            }

            return spriteSheet;
        },
        argv: [],
        json: true,
        failedText: '[]'
    }));
});

http.createServer(function (req, res) {
    var url_ = req.url,
        requestObject = url.parse(url_,true,false),
        serviceName,
        _pre_files,
        files,
        extensions;

    if (req.method === 'POST') {
        if (requestObject.pathname.startswith(services._prefix)) {
            serviceName = requestObject.pathname.substring(10);
            services.dispatch(serviceName, req, res);
        }

        //todo: delete it
        return;

        var body = '';
        req.on('data', function (data) {
            body += data;
        });
        req.on('end', function () {
            postData = qs.parse(body);

            if (requestObject.pathname.indexOf('/services/') === 0) {
                serviceName = requestObject.pathname.substring(10);
                if (serviceName === 'requestFile') {
                    if (postData.path) {
                        res.end(services.requestFile(postData.path));
                    }
                } else if (serviceName === 'writeFile') {
                    if (postData.path && postData.data) {
                        services.writeFile(postData.path, postData.data);
                        res.end('ok');
                    } else {
                        res.end('参数错误(path: ' + postData.path + ', data: ' + postData.data + ')！')
                    }
                } else if (serviceName === 'deleteFile') {
                    if (postData.path) {
                        res.end(services.deleteFile(postData.path) ? 'done' : 'failed');
                    }
                } else if (serviceName === 'listDirectory') {
                    if (postData.path) {
                        _pre_files = services.listDirectory(postData.path);
                    } else {
                        _pre_files = null;
                    }
                    if (postData.extension && _pre_files) {
                        files = [];
                        extensions = postData.extension.split('|')
                        for (var i = 0; i < _pre_files.length; i++) {
                            for (var j = 0; j < extensions.length; ++j) {
                                if (extensions[j].length > 0 
                                    && _pre_files[i].endswith(extensions[j])) {
                                    files.push(_pre_files[i]);
                                }
                            }
                        }
                    } else {
                        files = _pre_files;
                    }
                    res.end(JSON.stringify(files));
                } else if (serviceName === 'spriteSheet') {
                    res.end(JSON.stringify(services.spriteSheet()));
                } else {
                    res.end('');
                }
            } else {
                res.end('');
            }
        });
    } else if (req.method === 'GET') {
        var path,
            fileData,
            contentType;

        if (requestObject.pathname === '/') {
            path = '/index.html';
        } else if (requestObject.pathname.startswith('/fakepath')) {
            path = fakepathToRealPath(requestObject.pathname)
        } else {
            path = requestObject.pathname;
        }

        path = path.substring(1);
        fileData = services._services.requestFile.handler({path:path});
        if (fileData === false) {
            fileData = 'Page 404';
        }
        // console.log(path+': '+fileData.length)
        if (path.endswith('.js')) {
            contentType = 'text/javascript';
        } else if (path.endswith('.css')) {
            contentType = 'text/css';
        } else if (path.endswith('.html')) {
            contentType = 'text/html';
        } else if (path.endswith('.png')) {
            contentType = 'image/png';
        } else if (path.endswith('.jpg')) {
            contentType = 'image/jpeg';
        } else if (path.endswith('.bmp')) {
            contentType = 'image/bmp';
        } else if (path.endswith('.tmx')) {
            contentType = 'text/xml';
        } else {
            contentType = 'text/plain';
        }
        res.writeHead(200, {
            'Content-Length': fileData.length,
            'Content-Type': contentType
        });
        res.end(fileData);
    }
}).listen(8080, '');

console.log('running on http://localhost:8080/');


